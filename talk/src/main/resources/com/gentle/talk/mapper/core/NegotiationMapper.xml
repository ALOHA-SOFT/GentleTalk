<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gentle.talk.mapper.core.NegotiationMapper">

    <resultMap id="NegotiationMap" type="com.gentle.talk.domain.core.Negotiation">
        <id property="no" column="no"/>
        <result property="issueNo" column="issue_no"/>
        <result property="userNo" column="user_no"/>
        <result property="mediationProposal" column="mediation_proposal"/>
        <result property="negotiationProposal" column="negotiation_proposal"/>
        <result property="acceptedAt" column="accepted_at"/>
        <result property="finalizedAt" column="finalized_at"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <association property="issue" column="issue_no" javaType="Issue" select="selectIssue"></association>
        <association property="negotiator" column="user_no" javaType="Users" select="selectNegotiator"></association>
    </resultMap>

    <!-- 이슈 정보 조회 -->
    <select id="selectIssue" resultType="Issue">
        SELECT *
        FROM issues
        WHERE no = #{issueNo}
    </select>

    <!-- 협상가 정보 조회 -->
    <select id="selectNegotiator" resultType="Users">
        SELECT *
        FROM users
        WHERE no = #{userNo}
    </select>

    <!-- 이슈 번호로 협상 목록 조회 -->
    <select id="selectByIssueNo" resultMap="NegotiationMap">
        SELECT *
        FROM negotiations
        WHERE issue_no = #{issueNo}
        ORDER BY created_at DESC
    </select>

    <!-- 협상가 번호로 협상 목록 조회 -->
    <select id="selectByUserNo" resultMap="NegotiationMap">
        SELECT *
        FROM negotiations
        WHERE user_no = #{userNo}
        ORDER BY created_at DESC
    </select>

    <!-- 페이징 조회 -->
    <select id="listWithParams" resultMap="NegotiationMap">
        SELECT n.*
        FROM negotiations n
        WHERE 1=1
        <if test="userNo != null">
            AND n.user_no = #{userNo}
        </if>
        <if test="issueNo != null">
            AND n.issue_no = #{issueNo}
        </if>
        <if test="status != null and status != ''">
            AND n.status = #{status}
        </if>
        <if test="sortBy != null and sortBy.size() > 0">
            ORDER BY
            <foreach collection="sortBy" item="sortField" index="idx" separator=",">
                ${sortField}
            </foreach>
        </if>
        <if test="sortBy == null or sortBy.size() == 0">
            ORDER BY n.created_at DESC
        </if>
        <if test="limit != null and offset != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- 상태별 협상 개수 조회 -->
    <select id="countByStatus" resultType="int">
        SELECT COUNT(*)
        FROM negotiations
        WHERE user_no = #{userNo}
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
    </select>

    <!-- 최근 협상 조회 -->
    <select id="selectRecentNegotiations" resultMap="NegotiationMap">
        SELECT *
        FROM negotiations
        WHERE user_no = #{userNo}
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 진행 중인 협상 조회 -->
    <select id="selectOngoingNegotiations" resultMap="NegotiationMap">
        SELECT *
        FROM negotiations
        WHERE user_no = #{userNo}
        AND status IN ('대기', '수락')
        ORDER BY created_at DESC
    </select>

</mapper>
