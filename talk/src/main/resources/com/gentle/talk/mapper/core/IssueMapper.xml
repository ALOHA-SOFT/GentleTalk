<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gentle.talk.mapper.core.IssueMapper">

    <resultMap id="IssueMap" type="com.gentle.talk.domain.core.Issue">
        <id property="no" column="no"/>
        <result property="id" column="id"/>
        <result property="userNo" column="user_no"/>
        <result property="opponentUserNo" column="opponent_user_no"/>
        <result property="conflictSituation" column="conflict_situation"/>
        <result property="requirements" column="requirements"/>
        <result property="analysisResult" column="analysis_result"/>
        <result property="opponentName" column="opponent_name"/>
        <result property="opponentContact" column="opponent_contact"/>
        <result property="issueCode" column="issue_code"/>
        <result property="opponentRequirements" column="opponent_requirements"/>
        <result property="opponentAnalysisResult" column="opponent_analysis_result"/>
        <result property="mediationProposals" column="mediation_proposals"/>
        <result property="selectedMediationProposal" column="selected_mediation_proposal"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <association property="user" column="user_no" javaType="Users" select="selectUser"></association>
        <association property="opponentUser" column="opponent_user_no" javaType="Users" select="selectUser"></association>
    </resultMap>

    <!-- 회원 정보 조회 -->
    <select id="selectUser" resultType="Users">
        SELECT *
        FROM users
        WHERE no = #{userNo}
    </select>

    <!-- 이슈 코드로 조회 -->
    <select id="selectByIssueCode" resultMap="IssueMap">
        SELECT *
        FROM issues
        WHERE issue_code = #{issueCode}
    </select>

    <!-- 회원 번호로 이슈 목록 조회 -->
    <select id="selectByUserNo" resultMap="IssueMap">
        SELECT *
        FROM issues
        WHERE user_no = #{userNo}
        ORDER BY created_at DESC
    </select>

    <!-- 상대방 회원 번호로 이슈 목록 조회 -->
    <select id="selectByOpponentUserNo" resultMap="IssueMap">
        SELECT *
        FROM issues
        WHERE opponent_user_no = #{opponentUserNo}
        ORDER BY created_at DESC
    </select>

    <!-- 페이징 조회 -->
    <select id="listWithParams" resultMap="IssueMap">
        SELECT i.*
        FROM issues i
        WHERE 1=1
        <if test="userNo != null">
            AND (i.user_no = #{userNo} OR i.opponent_user_no = #{userNo})
        </if>
        <if test="status != null and status != ''">
            AND i.status = #{status}
        </if>
        <if test="search != null and search != ''">
            AND (i.conflict_situation LIKE CONCAT('%', #{search}, '%')
                OR i.requirements LIKE CONCAT('%', #{search}, '%')
                OR i.opponent_name LIKE CONCAT('%', #{search}, '%')
                OR i.issue_code LIKE CONCAT('%', #{search}, '%'))
        </if>
        <if test="sortBy != null and sortBy.size() > 0">
            ORDER BY
            <foreach collection="sortBy" item="sortField" index="idx" separator=",">
                ${sortField}
            </foreach>
        </if>
        <if test="sortBy == null or sortBy.size() == 0">
            ORDER BY i.created_at DESC
        </if>
        <if test="limit != null and offset != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- 상태별 이슈 개수 조회 -->
    <select id="countByStatus" resultType="int">
        SELECT COUNT(*)
        FROM issues
        WHERE (user_no = #{userNo} OR opponent_user_no = #{userNo})
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
    </select>

    <!-- 최근 이슈 조회 -->
    <select id="selectRecentIssues" resultMap="IssueMap">
        SELECT *
        FROM issues
        WHERE (user_no = #{userNo} OR opponent_user_no = #{userNo})
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

</mapper>
